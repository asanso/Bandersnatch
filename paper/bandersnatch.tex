\documentclass{amsart}

\usepackage{hyperref}
\usepackage[capitalize]{cleveref}
\usepackage{tikz}
\usepackage[all]{xy}
\usepackage[foot]{amsaddr}
\usepackage{xcolor}
\usepackage{tabularx}
\usepackage{booktabs}

%% \newcommand{\AS}[1]{\color{red}#1\color{black}}
\newcommand{\SM}[1]{\color{blue}#1\color{black}}

\newcommand{\Q}{\ensuremath{\mathbb Q}}
\newcommand{\Z}{\ensuremath{\mathbb Z}}
\newcommand{\Fp}{\ensuremath{\mathbb F_p}}
\newcommand{\End}{\ensuremath{\text{End}}}

\begin{document}
\title[Bandersnatch]{Bandersnatch: a fast elliptic curve built over the BLS12-381 scalar field.}
\author{Simon Masson}
\address{Heliax}
\author{Antonio Sanso}
\address{Ethereum Foundation and Ruhr Universit{\"a}t Bochum}


\maketitle
\medskip
\begin{abstract}
 In this short note we  introduce Bandersnatch a new elliptic curve built over the BLS12-381 \cite{bls12381} scalar field. The curve is similar to Jubjub \cite{jubjub} but is equipped with the GLV endomorphism \cite{C:GalLamVan01} hence it has faster scalar multiplication.
 \end{abstract}

\section{Introduction}
%BLS12-381
BLS12-381 is a pairing friendly curve created by Sean Bowe in 2017
\cite{bls12381}. Currently BLS12-381 is universally used for digital
signatures and zero-knowledge proofs by many project orbiting in the
blockchin universe: Zcash, Ethereum 2.0, Skale, Algorand, Dfinity,
Chia, and more.
%jubjub
The ZCash team also introduced a new curve built over the BLS12-381
scalar field Jubjub  \cite{jubjub}: a twisted Edwards curve that can
be made efficient inside of the zk-SNARK circuit.
%our goal
In order for some cryptographic application to scale, it is needed to
have a curve like Jubjub but with faster scalar multiplication. One
efficient way to speed scalar multiplication up is to employ the
celebrated GLV endomorphism \cite{C:GalLamVan01} (also used
by the “Bitcoin curve” - secp256k1).
This technique was until few months ago protected by a US Patent that
is now expired and freely usable.
We performed an exhaustive search of curves where the GLV endomorphism
could be used over the BLS12-381 scalar field using the Complex
Multiplication (CM) method of generating an elliptic curve.

\SM{TODO:more details on GLV? Why not possible on Jubjub, etc.}

\section{Small discriminant curves}

The GLV method~\cite{C:GalLamVan01} is a well known trick for accelerating the
scalar multiplication over particular curve. In a nutshell, it applies
to elliptic curves endowed with an efficiently computable endomorphism
$\psi$.
Generally, the $j=0$ and $1728$ curves are used because non-trivial
automorphisms fit very well, but it also applies for other curves, as
we will see in this section.

% notations
Let $E$ be an elliptic curve defined over $\Fp$. The Frobenius
map $(x,y)\mapsto (x^p,y^p)$ is an endomorphism of degree $p$ of the
curve and we denote $\xi(X) = X^2 - tX + p$ its minimal polynomial.
The coefficient $t$ is called the trace of the curve and is closely
related to the curve order: $\#E(\Fp) = p+1-t$.
In this work, we are looking for ordinary elliptic curves
corresponding to the case where $\End(E)$ is an order of the imaginary
quadratic field $\Q(\sqrt{t^2-4p})$.
We denote $-D$ to be the discriminant of $\End(E)$, and $\{\text{Id},\psi\}$
a basis of the endomorphism ring. The fundamental discriminant
corresponds to the discriminant of the maximal order containing $\End(E)$.
This way, $\psi$ is a degree $\frac{D+1}4$ or $D/4$ depending on the
value of $p$ modulo $4$, and $\psi$ can be defined using polynomials
of degree $O(D)$ thanks to the Vélu's formulas~\cite{velu71}.
Thus, $\psi$ is efficiently computable only for curves of small discriminant.
For example, for $p\equiv 1$ mod $3$, elliptic curves of $j$-invariant $0$
have discriminant $-3$ corresponding to $\psi(x,y) = (\beta x, y)$
where $\beta$ is an order $3$ element of $\Fp$.
In this particular case, the endomorphism $\psi$ can be evaluated
using only one mulltiplication in $\Fp$.

In this work, we look for curves of small discriminant in order to
find a curve defined over the BLS12-381 scalar field where the GLV
method applies. Moreover, we are looking for secure curves in the
sense that the curve and its twist are not threaten by subgroup
attacks, meaning that the order of the curve and its quadratic twist
has a large prime factor.

As the endomorphism cost is closely related to the discriminant, we
restrict to $-D \geq -388$. Moreover, isogenous curve have the same
order and we can restrict on fundamental discriminants.

We compute an exhaustive search among all the possible discriminant
($-292 \leq -D \leq -3$) in
\href{https://github.com/asanso/Bandersnatch/blob/main/code/small-disc-curves.py}{this
  file}, and we finally obtain an interesting curve for $-D = -2 \cdot 4$.
It means that the curve has an endomorphism $\psi$ satisfying $\psi^2
= [-2]$.


\begin{table*}[ht]
    \centering\footnotesize
    \begin{tabularx}{\textwidth}{ccl}
        \toprule
                            
        \textbf{Discriminant}    & \textbf{Curve security}  & \textbf{Curve Order Factorization} \\
        \midrule        
        -4  &  59-bit & \tt $2^{32} \cdot 5 \cdot  73 \cdot 906349^{2} \cdot 254760293^{2} \cdot$ \\
                              	&   & \tt  $627366603157944049492749525918888037$ \\
        -4  &  37-bit & \tt $2^{2} \cdot 29 \cdot 233 \cdot 34469 \cdot 1327789373 \cdot$  \\
         			&   & \tt  $19609848837063073 \cdot 159032890827948314857 \cdot$  \\
                              	&   & \tt  $13592380981501008165173$ \\
        -4  &  57-bit & \tt $2 \cdot 5 \cdot 19^2 \cdot 1709 \cdot 125527^2 \cdot 2508409^2 \cdot 2529403^2 \cdot$ \\
                              	&   & \tt  $13398994157557026219726057893872289$ \\
        -4  &  37-bit & \tt $2\cdot 3^2 \cdot 11^2 \cdot 13 \cdot 1481 \cdot 10177^2 \cdot 859267^2 \cdot 52437899^2 \cdot$  \\
        &   & \tt   $346160718017 \cdot 17179403131951992932701$ \\
        \textbf{-8}  &   \textbf{122-bit} & \tt  $\mathbf{2^{7} \cdot 3^{3} \cdot 151724175853953097452105730637112169670556}$ \\
                              	&   & \tt    $\mathbf{94857434315578142854216712503379}$ \\
       	\textbf{-8} &   \textbf{126-bit} & \tt  $\mathbf{2^{2} \cdot 131089687937815476198619351270464914593091551}$  \\
                              	&   & \tt  $\mathbf{89344057025178640330672968767280}$ \\                              
        -3  &   65-bit & \tt $2^{2} \cdot 3 \cdot 97 \cdot 19829809 \cdot 2514214987 \cdot 423384683867248993$ \\
                              	&   & \tt  $\cdot 2134123045011405514550171533246777540657$  \\
        -3  &  14-bit & \tt $2^{64} \cdot 906349^{4} \cdot 254760293^{4}$  \\
        -3  &  77-bit & \tt $7 \cdot 43 \cdot 1993 \cdot 2137 \cdot 43558993 \cdot 69032539613749 \cdot$\\
                              	&   & \tt  $13602493359071085768716057764426493417539936387$ \\
        -3  &  41-bit & \tt $3 \cdot 7 \cdot 13 \cdot 79 \cdot 2557 \cdot 33811 \cdot 1645861201 \cdot 75881076241177 \cdot$\\
                              	&   & \tt  $86906511869757553 \cdot 2591021580831339586968049$  \\
        -3  &  13-bit & \tt $3^2 \cdot 11^2 \cdot 19^2 \cdot 10177^2 \cdot 125527^2 \cdot 859267^2 \cdot$\\
                      	&   & \tt   $2508409^2 \cdot 2529403^2 \cdot 52437899^2$  \\
        -3  &  118-bit & \tt $ 836509 \cdot 62684173362302366716254984116352562$\\
              	&   & \tt   $658898559226765448628136638752264223$  \\
        -24  &  53-bit & \tt $2^2 ~ \cdot 3^2 ~ \cdot 7 ~ \cdot 19^2 ~ \cdot 127 ~ \cdot 29402034080953  ~ \cdot $  \\
         			&   & \tt  $2970884754778276642175743  \cdot 51958173461083102732933619896183$  \\    
        -24  &  86-bit & \tt $2^5 \cdot 5 \cdot 39628279 \cdot 1626653036429383 ~ \cdot$  \\
         			&   & \tt  $5084033436333303896254544125203989655961628847360751$  \\    
        -11  &  69-bit & \tt $5 \cdot 191 \cdot 5581 \cdot 18793 \cdot 48163 \cdot 46253594704380463613 \cdot$  \\
         			&   & \tt  $234994659112177964824772929105740802631219$  \\    			
        -11  &  73-bit & \tt $3^3 \cdot 11^2 \cdot 9269797 \cdot 17580060420191283788101 ~\cdot$  \\
         			&   & \tt  $98489243021895727533550278363068950783386787$  \\   
        -19  &  110-bit & \tt $ 7 \cdot11^2  \cdot 19  \cdot 23  \cdot 397  \cdot 419 \cdot 85164606460181$  \\
         			&   & \tt $5853300746394355082537783130102472030770781228663709$  \\   
        -19  &  74-bit & \tt $ 3^2 \cdot 5 \cdot 503 \cdot 10779490483 \cdot 433275286013779991 ~\cdot$  \\
         			&   & \tt $496004790576472865318555447011514143225709197$ \\   
        -88  &  61-bit & \tt $ 2^2 \cdot 11 \cdot 16984307 \cdot 24567897636186592260640293583411~\cdot$  \\
         			&   & \tt $2856011943096334248876229050495279019$ \\   
        -88  &  66-bit & \tt $ 2^9 \cdot 3^2 \cdot 31 \cdot 6133 \cdot 116471 \cdot 69487476515565975361139~\cdot$  \\
         			&   & \tt $7395321303462222792403892962962823887661$ \\   
        -132 &  73-bit & \tt $  2 \cdot 1753 \cdot 101235113104036296384208928969~\cdot$  \\
         			&   & \tt $ 147735694046206516694002011001189978280651761$\\   			
        -132 &  92-bit & \tt $ 2 \cdot 3^2 \cdot 7^2 \cdot 11 \cdot 23 \cdot 587 \cdot 701 \cdot 32299799971~\cdot$  \\
         			&   & \tt $ 17680048930794323282297555816406244723208910753042706097$\\   	
        -136 &  62-bit & \tt $  2^3 \cdot 7^3 \cdot 19^3 \cdot 10939 \cdot 11131315086725327441688173207 ~\cdot$  \\
         			&   & \tt $ 22880183990722565732708483545809090011$\\  
        -136 &  87-bit & \tt $  2^2 \cdot 5 \cdot 5741 \cdot 30851 \cdot 533874022134253  ~\cdot$  \\
         			&   & \tt  $ 27727003911863280112640822770482704089818204554997709$\\  
       	 -51 &  112-bit & \tt $  3^2 \cdot 5 \cdot 61223923 \cdot 19032456815260919958235476209079602152$  \\
         			&   & \tt  $ 581472436256880242087376371821$\\  
       	 -51 &  120-bit & \tt $  23^2 \cdot 41 \cdot 241762530200222188572307347080021973524221$  \\
         			&   & \tt   $ 4976078872315824946624471376737$\\  
       	 -228 &  114-bit & \tt $  2 \cdot 3^2 \cdot 19 \cdot 89 \cdot 5189 \cdot 33199285533115524379865450583354904966$  \\
         			&   & \tt   $ 5216704881072109228938825983287$\\  
       	 -228 &  81-bit & \tt $  2 \cdot 947 \cdot 277603 \cdot 28469787063396608749 \cdot 350300028163109$  \\
         			&   & \tt   $ 8433949558881855279377820347356133$\\  
       	 -244 &  89-bit & \tt $  2^2 \cdot  13 \cdot  523 \cdot  1702319 \cdot  2827715661581 \cdot  400540840463864$  \\
         			&   & \tt     $281554477443867787524026129785624892357$\\  
       	 -244 &  88-bit & \tt $  2^8 \cdot 3^2 \cdot 5 \cdot 71 \cdot 907 \cdot 2749 \cdot 146221 \cdot 2246269 ~\cdot $  \\
         			&   & \tt     $78282403792763726268814606048838426991002313842586233$\\  			
       	 -264 &  83-bit & \tt $  2^3 \cdot  11 \cdot  131 \cdot  12543757399 \cdot  2818746796297 ~\cdot  $  \\
         			&   & \tt    $ 128644386898323185670796964216580278004442975976117$\\  	
       	 -264 &  82-bit & \tt $  2^2 \cdot 3 \cdot 5^2 \cdot 2287 \cdot 2134790941497418864559 ~\cdot  $  \\
         			&   & \tt   $35800224519686371221374702160917676245061604829153$\\  
       	 -67 &  67-bit & \tt $  3479887483 \cdot 56938338857 \cdot 8474085246072233 ~\cdot  $  \\
         			&   & \tt   $31229547948360830580661852418419328496097$\\  			
       	 -67 &  79-bit & \tt $  3^2 \cdot 8478452882270519617659314063 ~\cdot  $  \\
         			&   & \tt   $687178242739912150244943675531904308095240025791$\\  	
       	 -276 &  70-bit & \tt $  2 \cdot 11^2 \cdot 8839 \cdot 78797899 \cdot 323360863688748558301 ~\cdot  $  \\
         			&   & \tt   $962072779162757054682642566861718434331839$\\  	
       	 -276 &  88-bit & \tt $  2 \cdot 3 \cdot 5 \cdot 6197 \cdot 138617 \cdot 16664750312513 ~\cdot  $  \\
         			&   & \tt  $122098537954380336134393591920380465673155302225951761$\\  	
       	 -292 &  92-bit & \tt $  2 \cdot  54983 \cdot  5220799 \cdot  2671917733 ~\cdot  $  \\
         			&   & \tt   $34182989172931400170646219057675857732332014936511085961$\\  	
       	 -292 &  86-bit & \tt $  2 \cdot 11^2 \cdot 149 \cdot 354689 \cdot 24012883 \cdot 32483123 ~\cdot  $  \\
         			&   & \tt  $5256262975599702832600322521527774038593961569071017$\\  	
        \bottomrule
    \end{tabularx}
    \caption{Curve Order for discriminants $-292 \leq -D \leq -3$ }
    \label{tab:group-order-factorization}
\end{table*}

In the next section, we present this curve and several properties
related to the  GLV scalar multiplication in this case.

\SM{TODO: explain our algorithm for finding curves, subgroup and twist
  security.}

\SM{TODO: not defined: quadratic twist, isogenous curves, fundamental
  discriminant.}

\section{Bandersnatch} 

\SM{TODO: add parameters for weierstrass so that people can use sagemath
  easily to create the curve and see its order.}

The Bandersnatch curve can be represented in the Weierstrass model
using the following parameters:
\begin{verbatim}
p=52435875175126190479447740508185965837690552500527637822603658699938581184513
a=20856223409030707214153620029242927260100058688354534505372746703669794261922
b=4118395616383396936705917269457205707251888519744679123386326773690169742488
E=EllipticCurve(GF(p), [a,b])
\end{verbatim}
This curve has discriminant $-8$, and $j$-invariant $8000$. It means
that $8000$ is a root of the Hilbert class polynomial $H_{-8}$.
The bandersnatch curve order is $2^2\cdot r$ for a $253$-bit long
prime $r$.
% 13108968793781547619861935127046491459309155893440570251786403306729687672801
This lets us represent our curve in Twisted Edwards coordinates.
In this model, the Bandersnatch curve can be defined by the equation
$$E_\text{TE}:-5x^2+y^2 = 1 + \frac{138827208126141220649022263972958607803}{171449701953573178309673572579671231137}x^2y^2$$ 
The quadratic twist of $E_\text{TE}$ has order $2^7 \cdot 3^3 \cdot r'$ another
prime $r'$ of $244$ bits
%15172417585395309745210573063711216967055694857434315578142854216712503379
and so our curve satisfies twist security after a quick cofactor
check.
The different attacks on the Bandersnatch curve lead to $125.75$ bits
of security.

From that, we exhibit the degree $2$ endomorphism in Twisted Edwards
coordinates:
$$\psi(x,y,z) = (xa_1(y+a_2z)(y+a_3z), b_1(y+b_2z)(y+b_3z)yz^2,
(y+c_1z)(y+c_2z)yz^2) \qquad a_i, b_i, c_i \in \Fp.$$
This map can be computed in 17 multiplications and 6 additions modulo $p$.

A twisted Edwards curve is always birationally equivalent to a
Montgomery curve.
While the Twisted Edwards model fits better for $\mathbb F_p$ circuit
arithmetic, we provide here the Montgomery version because the scalar
multiplication is more efficient in this context.
$$E_\text{M}: By^2 = x^3 + Ax^2 + x$$
\begin{align*}
  B &= \text{\small{43133420749626800644911662702407007968989685651477499770299667990488723916667}}\\
  A &= \text{\small{29978822694968839326280996386011761570173833766074948509196803838190355340952}}.
\end{align*}


\section{Comparison}

\SM{TODO: talk about $a=-1$ vs $a=-5$, and give more precise complexity
analysis and benchmarks.}

%### Scalar multiplication improvement
From the efficient endomorphism $\psi$, it is easy to apply the GLV method and improve the scalar multiplication cost:
Roughly, a scalar multiplication $[n]P$ cost $(\log n) \text{Dbl} + (\log n/2) \text{Add}$.
Using the GLV endomorphism, we can compute $[n]P$ using $(\log n/2 )\text{Dbl} + (3\log n/8) \text{Add}$, plus few precomputations.

We performed `python` benchmarks between the double-and-add algorithm and the GLV method applied in the case of our curve, and the GLV version is about 30\% faster 
\footnote{Source code \url{https://github.com/asanso/Bandersnatch/}.}

\bigskip
\paragraph*{\textbf{Acknowledgments.}} we would like to thank Luca De Feo, Justin Drake, Dankrad Feist, Daira Hopwood and Zhenfei Zhang for fruitful discussions.

\bibliography{bandersnatch,cryptobib/abbrev3,cryptobib/crypto}
\bibliographystyle{unsrt}
\end{document}
