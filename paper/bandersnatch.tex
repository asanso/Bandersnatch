\documentclass{article}

\usepackage{hyperref}
%\usepackage[capitalize]{cleveref}
\usepackage{tikz}
\usepackage[all]{xy}
%\usepackage[foot]{amsaddr}
\usepackage{amsmath,amsfonts,amssymb,amsthm}
\usepackage{xcolor}
\usepackage{tabularx}
\usepackage{booktabs}

%% \newcommand{\AS}[1]{\color{red}#1\color{black}}
\newcommand{\SM}[1]{\color{blue}#1\color{black}}

\newcommand{\Q}{\ensuremath{\mathbb Q}}
\newcommand{\Z}{\ensuremath{\mathbb Z}}
\newcommand{\Fp}{\ensuremath{\mathbb F_p}}
\newcommand{\End}{\ensuremath{\text{End}}}

\theoremstyle{definition}
\newtheorem*{remark}{Remark}
\newtheorem*{example}{Example}


\title{Bandersnatch: a fast elliptic curve built over the BLS12-381 scalar field.}
\author{Simon Masson and Antonio Sanso}
%\address{Heliax}
%\author{Antonio Sanso}
%\address{Ethereum Foundation and Ruhr Universit{\"a}t Bochum}

\begin{document}

\maketitle
\medskip
\begin{abstract}
 In this short note, we introduce Bandersnatch a new elliptic curve
 built over the BLS12-381~\cite{bls12381} scalar field. The curve is
 similar to Jubjub~\cite{jubjub} but is equipped with an efficient
 endomorphism, allowing a fast scalar multiplication algorithm.
\end{abstract}

\SM{Add refs: CM method, Silverman hasse bound, number theory orders
  quad im field, twisted
edwards curves (eprint with group law $a=-1$?), montgomery curve (smith)}


\section{Introduction}
%BLS12-381
BLS12-381 is a pairing-friendly curve created by Sean Bowe in
2017~\cite{bls12381}.
Currently, BLS12-381 is universally used for digital
signatures and zero-knowledge proofs by many project orbiting in the
blockchin universe: Zcash, Ethereum 2.0, Skale, Algorand, Dfinity,
Chia, and more.
%jubjub
The ZCash team also introduced another curve called
Jubjub~\cite{jubjub}, built over the BLS12-381 scalar field $\mathbb
F_{r_\text{BLS}}$.
This curve is not pairing-friendly, but leads to constructions where
$\mathbb F_{r_\text{BLS}}$ arithmetic circuits can be manipulated
using the BLS12-381 curve.
The Jubjub curve can be represented in the twisted Edwards
coordinates, allowing efficiency inside ZK-SNARK circuits.
In order for some cryptographic application to scale, it is needed to
have efficient scalar multiplication on the non-pairing-friendly
curve.
The main drawback of Jubjub is the slow scalar multiplication
algorithm, compared for example with the ``Bitcoin curve''
(SECP256k1).
It comes from the fact that the curve does not have an efficiently
computable endomorphism, necessary for computing scalar
multiplications using the GLV method~\cite{C:GalLamVan01} (a technique
protected by a US patent until few months ago, but that expired and is
freely usable now).

\paragraph{Our contribution.}
The Jubjub curve is a curve with a large discriminant, meaning that
the GLV method is not possible on this curve.
We performed an exhaustive search of curves of small discriminant,
defined over the BLS12-381 scalar field. This way, we obtain an
elliptic using the Complex Multiplication method, where the scalar
multiplication algorithm is efficient thanks to the GLV
method~\cite{C:GalLamVan01}.

\paragraph{Organization of the paper.}
In Section~\ref{sec:small-disc-curves}, we describe how we obtained
several curves allowing the GLV method together with cryptographic
security.
Then, we introduce in Section~\ref{sec:bandersnatch} the Bandersnatch
curve in different models (in Weierstrass, Montgomery and Twisted Edwards
coordinates).
Finally, we compare the scalar multiplication algorithm over
the Bandersnatch and the Jubjub curves in
Section~\ref{sec:comparison} in a practical point of view.


\section{Small discriminant curves}\label{sec:small-disc-curves}

The GLV method~\cite{C:GalLamVan01} is a well known trick for accelerating the
scalar multiplication over particular curve. In a nutshell, it applies
to elliptic curves where an endomorphism $\psi$ can be efficiently computed.
The GLV method applies in particular for $j=0$ (resp. $1728$) curves
because a non-trivial automorphism can be computed using only one
modular multiplication (see Example~\ref{ex:psi-j0}).
The method also applies for other curves where the endomorphism is
slightly more expensive, called \emph{small discriminant} curves.

% notations
Let $E$ be an elliptic curve defined over $\Fp$ of trace $t$. $E$ and
its quadratic twist $E^t$ are $\mathbb F_{p^2}$-isomorphic curves and
their order over $\Fp$ is given by the formula
$$\#E(\Fp) = p+1-t\qquad \#E^t(\Fp) = p+1+t.$$
In this work, we are looking for cryptographic applications based on
ordinary elliptic curves, meaning that we look for $t\not\equiv 0
\bmod p$. The endomorphism ring of these curves have a particular
structure: $\End(E)$ is an order of the imaginary quadratic field
$\Q(\sqrt{t^2-4p})$.
From now, we denote $-D$ to be the discriminant of $\End(E)$, and
$\{\text{Id},\psi\}$ a basis of the endomorphism ring.
The fundamental discriminant corresponds to the discriminant of the
maximal order containing $\End(E)$.
This way, $\psi$ is a degree $\frac{D+1}4$ or $D/4$ depending on the
value of $D$ modulo $4$, and $\psi$ can be defined using polynomials
of degree $O(D)$ thanks to the VÃ©lu's formulas~\cite{velu71}.
Thus, the evaluation of $\psi$ is efficient only for curves of small
discriminant.

\begin{example}\label{ex:psi-j0}
  Let $p\equiv 1$ mod $3$, and $E:y^2=x^3+1$.
  $E$ has discriminant $-3$ and $\End(E) \simeq
  \Z\left[\frac{1+\sqrt{-3}}{2}\right]$. The endomorphism $\psi$
  corresponding to $\frac{1+\sqrt{-3}}2$ can be
    computed as $\psi(x,y) = (\beta x, y)$ where $\beta$ is an order
    $3$ element of $\Fp$.
\end{example}

In this work, we restrict to curves defined over the BLS12-381 scalar
field, and also look for cryptographic security. Curves with $-D=-3$
and $-4$ do not have a large prime subgroup defined over $\Fp$. Hence,
we look for small discriminant $-D<-4$ curves with subgroup and
twist-subgroup security. It means that $\#E(\Fp)$ has a roughly 256-bit
prime factor, as well as $\#E^t(\Fp)$.

As the endomorphism cost is closely related to the discriminant, we
restrict to $-D \geq -388$ so that $\psi$ can be efficiently computed.
Moreover, we restrict on fundamental discriminants:
\begin{itemize}
  \item Fundamental discriminants are the discriminant of the maximal
    orders of imaginary quadratic fields. We denote $O_{-D}$ the
    maximal order of discriminant $-D$.
  \item Elliptic curves with $\End(E) \subset O_{-D}$ are isogenous
    curves, meaning that there is a rational map between them.
  \item Isogenous curves have the same order so that we can restrict
    on fundamental discriminants for our search.
\end{itemize}

We compute an exhaustive search among all the possible (fundamental)
discriminants ($-292 \leq -D \leq -3$).
Given a discriminant $-D$, roughly half of the curves are
supersingular and hence not interesting for our cryptographic
applications.
We list in Table~\ref{tab:group-order-factorization} the ordinary
curves we obtained.
The generation of these curves is reproducible
using~\href{https://github.com/asanso/Bandersnatch/blob/main/code/small-disc-curves.py}{this
  file}.
We finally obtain an interesting curve for $-D = -8$ with large prime
order subgroups on both the curve and its twist.
We present in Section~\ref{sec:bandersnatch} the curve in several
models, together with the endomorphism in order to apply the GLV
scalar multiplication algorithm.

\begin{table*}[!ht]
    \centering\footnotesize
    \begin{tabularx}{\textwidth}{ccl}
        \toprule                            
        $\mathbf{-D}$    & \textbf{Curve sec.}  & \textbf{Curve order} \\
        \midrule        
$-3$ & $65$-bit & $2^{2}  \cdot 3  \cdot 97  \cdot 19829809  \cdot 2514214987  \cdot 423384683867248993  \cdot p_{131}$\\
 & $14$-bit & $2^{64}  \cdot 906349^{4}  \cdot p_{28}^{4}$\\
 & $77$-bit & $7  \cdot 43  \cdot 1993  \cdot 2137  \cdot 43558993  \cdot 69032539613749  \cdot p_{154}$\\
 & $41$-bit & $3  \cdot 7  \cdot 13  \cdot 79  \cdot 2557  \cdot 33811
        \cdot 1645861201  \cdot 75881076241177 \cdot$\\
 &          & $86906511869757553  \cdot p_{82}$\\
 & $13$-bit & $3^{2}  \cdot 11^{2}  \cdot 19^{2}  \cdot 10177^{2}  \cdot 125527^{2}  \cdot 859267^{2}  \cdot 2508409^{2}  \cdot 2529403^{2}  \cdot p_{26}^{2}$\\
 & $118$-bit & $836509  \cdot p_{236}$\\
$-4$ & $59$-bit & $2^{32}  \cdot 5  \cdot 73  \cdot 906349^{2}  \cdot 254760293^{2}  \cdot p_{119}$\\
 & $37$-bit & $2^{2}  \cdot 29  \cdot 233  \cdot 34469  \cdot
        1327789373  \cdot 19609848837063073 \cdot$\\
 &          & $159032890827948314857  \cdot p_{74}$\\
 & $37$-bit & $2  \cdot 3^{2}  \cdot 11^{2}  \cdot 13  \cdot 1481  \cdot 10177^{2}  \cdot 859267^{2}  \cdot 52437899^{2}  \cdot 346160718017  \cdot p_{74}$\\
 & $57$-bit & $2  \cdot 5  \cdot 19^{2}  \cdot 1709  \cdot 125527^{2}  \cdot 2508409^{2}  \cdot 2529403^{2}  \cdot p_{114}$\\
$\mathbf{-8}$ & $\mathbf{122}$\textbf{-bit} & $\mathbf{2^{7}  \cdot 3^{3}  \cdot p_{244}}$\\
 & $\mathbf{126}$\textbf{-bit} & $\mathbf{2^{2}  \cdot p_{253}}$\\
$-11$ & $69$-bit & $5  \cdot 191  \cdot 5581  \cdot 18793  \cdot 48163  \cdot 46253594704380463613  \cdot p_{138}$\\
 & $73$-bit & $3^{3}  \cdot 11^{2}  \cdot 9269797  \cdot 17580060420191283788101  \cdot p_{147}$\\
$-19$ & $110$-bit & $7  \cdot 11^{2}  \cdot 19  \cdot 23  \cdot 397  \cdot 419  \cdot p_{220}$\\
 & $74$-bit & $3^{2}  \cdot 5  \cdot 503  \cdot 10779490483  \cdot 433275286013779991  \cdot p_{149}$\\
$-24$ & $53$-bit & $2^{2}  \cdot 3^{2}  \cdot 7  \cdot 19^{2}  \cdot 127  \cdot 29402034080953  \cdot 2970884754778276642175743  \cdot p_{106}$\\
 & $86$-bit & $2^{5}  \cdot 5  \cdot 39628279  \cdot 1626653036429383  \cdot p_{172}$\\
$-51$ & $112$-bit & $3^{2}  \cdot 5  \cdot 61223923  \cdot p_{224}$\\
 & $120$-bit & $23^{2}  \cdot 41  \cdot p_{241}$\\
$-67$ & $67$-bit & $3479887483  \cdot 56938338857  \cdot 8474085246072233  \cdot p_{135}$\\
 & $79$-bit & $3^{2}  \cdot 8478452882270519617659314063  \cdot p_{159}$\\
$-88$ & $61$-bit & $2^{2}  \cdot 11  \cdot 16984307  \cdot 24567897636186592260640293583411  \cdot p_{122}$\\
 & $66$-bit & $2^{9}  \cdot 3^{2}  \cdot 31  \cdot 6133  \cdot 116471  \cdot 69487476515565975361139  \cdot p_{133}$\\
$-132$ & $73$-bit & $2  \cdot 1753  \cdot 101235113104036296384208928969  \cdot p_{147}$\\
 & $92$-bit & $2  \cdot 3^{2}  \cdot 7^{2}  \cdot 11  \cdot 23  \cdot 587  \cdot 701  \cdot 32299799971  \cdot p_{184}$\\
$-136$ & $62$-bit & $2^{3}  \cdot 7^{3}  \cdot 19^{3}  \cdot 10939  \cdot 11131315086725327441688173207  \cdot p_{125}$\\
 & $87$-bit & $2^{2}  \cdot 5  \cdot 5741  \cdot 30851  \cdot 533874022134253  \cdot p_{175}$\\
$-228$ & $114$-bit & $2  \cdot 3^{2}  \cdot 19  \cdot 89  \cdot 5189  \cdot p_{228}$\\
 & $81$-bit & $2  \cdot 947  \cdot 277603  \cdot 28469787063396608749  \cdot p_{162}$\\
$-244$ & $89$-bit & $2^{2}  \cdot 13  \cdot 523  \cdot 1702319  \cdot 2827715661581  \cdot p_{179}$\\
 & $88$-bit & $2^{8}  \cdot 3^{2}  \cdot 5  \cdot 71  \cdot 907  \cdot 2749  \cdot 146221  \cdot 2246269  \cdot p_{176}$\\
$-264$ & $83$-bit & $2^{3}  \cdot 11  \cdot 131  \cdot 12543757399  \cdot 2818746796297  \cdot p_{167}$\\
 & $82$-bit & $2^{2}  \cdot 3  \cdot 5^{2}  \cdot 2287  \cdot 2134790941497418864559  \cdot p_{165}$\\
$-276$ & $70$-bit & $2  \cdot 11^{2}  \cdot 8839  \cdot 78797899  \cdot 323360863688748558301  \cdot p_{140}$\\
 & $88$-bit & $2  \cdot 3  \cdot 5  \cdot 6197  \cdot 138617  \cdot 16664750312513  \cdot p_{177}$\\
$-292$ & $92$-bit & $2  \cdot 54983  \cdot 5220799  \cdot 2671917733  \cdot p_{185}$\\
 & $86$-bit & $2  \cdot 11^{2}  \cdot 149  \cdot 354689  \cdot
24012883  \cdot 32483123  \cdot p_{172}$\\
\bottomrule
    \end{tabularx}
    \caption{Curves for discriminants $-3 \geq -D \geq -292$.}
    \label{tab:group-order-factorization}
\end{table*}

\section{Bandersnatch}\label{sec:bandersnatch}

The Bandersnatch is obtained from a discriminant $-D = -8$, meaning
that the endomorphism ring is $\Z[\sqrt{-2}]$.
We obtain the curve $j$-invariant using the Complex Multiplication
method, based on the Hilbert class polynomial $H_{-D}(X)$, where
$\text{Ell}_{-D}$ denotes the set of elliptic curves of endomorphism
ring of discriminant $-D$.
Using SageMath, one obtains that the Bandersnatch $j$-invariant is
$8000$ using \texttt{hilbert\_class\_polynomial(-8).roots()}.
From the $j$-invariant, we can obtain the curve equation in different
models. Before looking into details three different representations,
we briefly recall how to exhibit the degree $2$ endomorphism $\psi$.

\paragraph{Degree 2 endomorphism.}
The endomorphism $\psi$ has a kernel generated by a $2$-torsion
point. Hence, we can obtain the rational maps defining $\psi$ by
looking at the curves $2$-isogenous to Bandersnatch. Only one has the
same $j$-invariant (which is $8000$, the unique root of the
$j$-invariant $8000$, meaning that up to an isomorphism, the VÃ©lu's
formulas~\cite{velu71} let us obtain compute $\psi$. More details can
be found
in~\href{https://github.com/asanso/Bandersnatch/blob/main/code/get\_params.py}{this
  file}.

\SM{talk about the eigen value somewhere}

\subsection{Weierstrass curve}
The Bandersnatch curve can be represented in the Weierstrass model
using the following parameters:
\begin{verbatim}
p=0x73eda753299d7d483339d80809a1d80553bda402fffe5bfeffffffff00000001
E=EllipticCurve(GF(p), [-3763200000, -78675968000000])
\end{verbatim}

\begin{remark}
  Using SageMath, \texttt{EllipticCurve\_from\_j(8000)} computes a
  Weierstrass equation of the quadratic twist of Bandersnatch.
  Bandersnatch can then be obtained using
  \texttt{EllipticCurve\_from\_j(8000).quadratic\_twist()}.
\end{remark}

The endomorphism $\psi$ can obtained using the method described above.
Finally,
$$\psi_\text{W}(x,y) = \left(u^2\cdot \frac{x^2+r_1x+r_0}{x+s_0}, u^3\cdot
y\cdot \frac{x^2+t_1x+t_0}{(x+s_0)^2}\right)$$
for coefficients $u, r_0, r_1, s_0, t_0, t_1$ given in the
\texttt{params-W.py} file in our repository.

\subsection{Twisted Edwards curve}
Bandersnatch can also be represented in Twisted Edwards coordinates.
In this model, the Bandersnatch curve can be defined by the equation
$$E_\text{TE}:-5x^2+y^2 = 1 +
\frac{138827208126141220649022263972958607803}{171449701953573178309673572579671231137}x^2y^2$$
Twisted Edwards representation is more efficient using a coefficient
$a = -1$, but our curve is not on this form because $-5$ is not a
square in $\Fp$. Finally, the curve $-x^2+y^2 = 1 -dx^2y^2/5$ is the quadratic
twist of Bandersnatch.

From this representation, we exhibit the degree $2$ endomorphism in
Twisted Edwards coordinates:
$$\psi_\text{TE}(x,y,z) = (xa_1(y+a_2z)(y+a_3z), b_1(y+b_2z)(y+b_3z)yz^2,
(y+c_1z)(y+c_2z)yz^2).$$
Again, the coefficients $a_i, b_i, c_i \in \Fp$ can be obtained in the
\texttt{params-TE.py} in our repository.
This map can be computed in 17 multiplications and 6 additions modulo $p$.
A twisted Edwards curve is always birationally equivalent to a
Montgomery curve.

\subsection{Montgomery curve}
While the Twisted Edwards model fits better for $\mathbb F_p$ circuit
arithmetic, we provide here the Montgomery version because the scalar
multiplication is more efficient in this context.
$$E_\text{M}: By^2 = x^3 + Ax^2 + x$$
\begin{align*}
  B &= \text{\small{\tt 0x300c3385d13bedb7c9e229e185c4ce8b1dd3b71366bb97c30855c0aa41d62727}}\\
  A &= \text{\small{\tt 0x4247698f4e32ad45a293959b4ca17afa4a2d2317e4c6ce5023e1fd63d1b5de98}}.
\end{align*}
Montgomery curves allow efficient scalar multiplication using the
Montgomery ladder. We provide here the endomorphism $\psi$ in this
representation:
$$\psi_\text{M}(x,z) = (-(x-z)^2 - cxz, 2xz)$$
The parameter $c$ is provided in the file \texttt{params-M.py} in our
repository.

\subsection{Security of Bandersnatch}

The bandersnatch curve order is $2^2\cdot r$ for a $253$-bit long
prime $r$.
% 13108968793781547619861935127046491459309155893440570251786403306729687672801
Its quadratic twist has order
$2^7 \cdot 3^3 \cdot r'$, where $r'$ is another prime of $244$ bits.
%15172417585395309745210573063711216967055694857434315578142854216712503379
Hence, the Bandersnatch curve satisfies twist security after a quick cofactor
check.
We estimate that the Bandersnatch curve (resp. its quadratic twist)
has $126$ bits of security (resp. $122$ bits of security).


\section{Comparison}\label{sec:comparison}

\SM{TODO benchmarks:}
\begin{itemize}
\item both with and without the endomorphism,
\item using windowing techniques,
\item with a fixed-time (side-channel-resistant) algorithm.
\end{itemize}

%### Scalar multiplication improvement
The twisted Edwards representation is very used in practice, and we
now focus on the comparison between Jubjub and Bandersnatch in this
model.

\paragraph{Jubjub scalar multiplication.}
Because of its large discriminant, the scalar multiplication on Jubjub
is a basic double-and-add algorithm, meaning that it computes a
multiplication by $n$ in $\log n$ doublings and $\log n/2$
additions (in average) on the curve. 

\paragraph{Bandersnatch scalar multiplication.}
The endomorphism $\psi$ lets us compute the scalar multiplication
faster than a double-and-add algorithm with few precomputations. For a
point $P$ and a scalar $n$, we first evaluate $\psi$ at $P$ and
decompose $n = n_1 + \lambda n_2$. Then a multi scalar multiplication
is computed in $\log n/2$ doublings and $3\log n/8$ additions (in average) on the curve.

\paragraph{Benchmarks.}
The \href{https://github.com/zhenfeizhang/bandersnatch-glv}{Rust implementation} of the Bandersnatch scalar multiplication
algorithm confirms our estimations: the GLV method is $40\%$ faster
than the Jubjub implementation.

\bigskip
\paragraph*{\textbf{Acknowledgments.}} We would like to thank Luca De
Feo, Justin Drake, Dankrad Feist, Daira Hopwood and Zhenfei Zhang for
fruitful discussions.

\bibliography{bandersnatch,cryptobib/abbrev3,cryptobib/crypto}
\bibliographystyle{unsrt}
\end{document}
